name: èŠ‚ç‚¹æ£€æŸ¥
run-name: ${{ github.actor }} æ­£åœ¨æ£€æŸ¥èŠ‚ç‚¹
on:
#  workflow_run: # åœ¨èŠ‚ç‚¹ç´¢å¼•åè¿›è¡Œ
#    workflows:
#      - èŠ‚ç‚¹ç´¢å¼•
#    types:
#      - completed
#  schedule:
#   - cron: "20 */4 * * *" # æ¯å››ä¸ªå°æ—¶èŠ‚ç‚¹æ£€æŸ¥
#   - cron: "20 0,4,8,12,16,20 * * *" # é¿å¼€èŠ‚ç‚¹ç´¢å¼•æ—¶é—´
#  push:
#     branches:
#       - master
#     paths:
#      - 'raw/**'
  workflow_dispatch:

permissions: write-all

jobs:
  proxies_split:
      runs-on: ubuntu-latest
      steps:

        - name: æ­å»ºç¯å¢ƒ 
        - uses: actions/checkout@v4
        - uses: actions/setup-python@v4
          with:
            python-version: '3.11'
            cache: 'pip' # pipç¼“å­˜
        - uses: actions/setup-node@v4
          with:
            node-version: latest
            cache: 'npm'   
        - run: |
            sudo timedatectl set-timezone 'Asia/Shanghai' 
            python -m pip install --upgrade pip
            pip install -r requirements.txt
            shell: bash
        - name: èŠ‚ç‚¹åˆ†å‰² 
          run: python ./check/proxies-split.py
        #- name: èŠ‚ç‚¹åˆæˆ
        #  run :
        #    cat ./collected-proxies/row-url/all_* >./collected-proxies/row-url/all.txt
        - name: å¯¹æ¯”ä»“åº“ # Commit Files # æäº¤
          run: |
            git config --local user.email "932624033@qq.com"
            git config --local user.name "yyyr-otz"
            git add -A ./collected-proxies/row-url/all* ./collected-proxies/row-url/actives* ./collected-proxies/xray-json/actives*
            git diff-index --quiet HEAD || (git commit -a -m " èŠ‚ç‚¹æ£€æŸ¥-åˆ†å‰²å®Œæˆ ğŸ• $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M %Z')" --allow-empty)
#         # git commit -am "èŠ‚ç‚¹æ£€æŸ¥-åˆ†å‰²å®Œæˆ $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M %Z')"
        - name: æ¨é€æ›´æ”¹ # Push Changes # æ¨é€
          uses: ad-m/github-push-action@v0.6.0
          with:
            github_token: ${{ secrets.ACTIONS_SECRETS_TOKEN }}
            branch: master
            
  proxies-check_1: 
    needs: [proxies_split]
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.ACTIONS_SECRETS_TOKEN }}
      REPO: ${{github.repository}}
      DEBUG_MODE: 0
    steps:
      - name: æ­å»ºç¯å¢ƒ 
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip' # pipç¼“å­˜
      - uses: actions/setup-node@v4
        with:
          node-version: latest
          cache: 'npm'
      - run: |
          sudo timedatectl set-timezone 'Asia/Shanghai'  
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          shell: bash
      - name: æ£€æŸ¥èŠ‚ç‚¹ all_1
        run: python ./check/checkProxies.py -n 1
        shell: bash
      - name: å¯¹æ¯”ä»“åº“ # Commit Files # æäº¤
        run: |
          git config --local user.email "932624033@qq.com"
          git config --local user.name "yyyr-otz"
          git add -u ./collected-proxies/row-url/all_1 ./collected-proxies/row-url/actives_1 ./collected-proxies/xray-json/actives_now_1
          git diff-index --quiet HEAD || (git commit -a -m "ğŸ‘ï¸â€ğŸ—¨ï¸ all1èŠ‚ç‚¹æ£€æŸ¥å®Œæˆ ğŸ•’ $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M %Z')" --allow-empty)
#          git commit -am "èŠ‚ç‚¹èµ„æºæ›´æ–° $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M %Z')"
      - name: æ¨é€æ›´æ”¹ # Push Changes # æ¨é€
        uses: ad-m/github-push-action@v0.6.0
        with:
          github_token: ${{ secrets.ACTIONS_SECRETS_TOKEN }}
          branch: master

  proxies-check_2: 
    needs: [proxies_split]
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.ACTIONS_SECRETS_TOKEN }}
      REPO: ${{github.repository}}
      DEBUG_MODE: 0
    steps:
      - name: æ­å»ºç¯å¢ƒ 
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip' # pipç¼“å­˜
      - uses: actions/setup-node@v4
        with:
          node-version: latest
          cache: 'npm'
      - run: |
          sudo timedatectl set-timezone 'Asia/Shanghai'  
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          shell: bash
      - name: æ£€æŸ¥èŠ‚ç‚¹ all_2
        run: python ./check/checkProxies.py -n 2
        shell: bash
      - name: å¯¹æ¯”ä»“åº“ # Commit Files # æäº¤
        run: |
          git config --local user.email "932624033@qq.com"
          git config --local user.name "yyyr-otz"
          git add -u ./collected-proxies/row-url/all_2 ./collected-proxies/row-url/actives_2 ./collected-proxies/xray-json/actives_now_2
          git diff-index --quiet HEAD || (git commit -a -m "ğŸ‘ï¸â€ğŸ—¨ï¸ all2èŠ‚ç‚¹æ£€æŸ¥å®Œæˆ ğŸ•’ $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M %Z')" --allow-empty)
#          git commit -am "èŠ‚ç‚¹èµ„æºæ›´æ–° $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M %Z')"
      - name: æ¨é€æ›´æ”¹ # Push Changes # æ¨é€
        uses: ad-m/github-push-action@v0.6.0
        with:
          github_token: ${{ secrets.ACTIONS_SECRETS_TOKEN }}
          branch: master

  proxies-check_3: 
    needs: [proxies_split]
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.ACTIONS_SECRETS_TOKEN }}
      REPO: ${{github.repository}}
      DEBUG_MODE: 0
    steps:
      - name: æ­å»ºç¯å¢ƒ 
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip' # pipç¼“å­˜
      - uses: actions/setup-node@v4
        with:
          node-version: latest
          cache: 'npm'
      - run: |
          sudo timedatectl set-timezone 'Asia/Shanghai'  
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          shell: bash
      - name: æ£€æŸ¥èŠ‚ç‚¹ all_3
        run: python ./check/checkProxies.py -n 3
        shell: bash
      - name: å¯¹æ¯”ä»“åº“ # Commit Files # æäº¤
        run: |
          git config --local user.email "932624033@qq.com"
          git config --local user.name "yyyr-otz"
          git add -u ./collected-proxies/row-url/all_3 ./collected-proxies/row-url/actives_3 ./collected-proxies/xray-json/actives_now_3
          git diff-index --quiet HEAD || (git commit -a -m "ğŸ‘ï¸â€ğŸ—¨ï¸ all3èŠ‚ç‚¹æ£€æŸ¥å®Œæˆ ğŸ•’ $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M %Z')" --allow-empty)
#          git commit -am "èŠ‚ç‚¹èµ„æºæ›´æ–° $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M %Z')"
      - name: æ¨é€æ›´æ”¹ # Push Changes # æ¨é€
        uses: ad-m/github-push-action@v0.6.0
        with:
          github_token: ${{ secrets.ACTIONS_SECRETS_TOKEN }}
          branch: master

  proxies_cat:
      needs: [proxies_split, proxies-check_1, proxies-check_2, proxies-check_3]
      runs-on: ubuntu-latest
      steps:
        - name: æ­å»ºç¯å¢ƒ 
        - uses: actions/checkout@v4
        - uses: actions/setup-python@v4
          with:
            python-version: '3.11'
            cache: 'pip' # pipç¼“å­˜
        - uses: actions/setup-node@v4
          with:
            node-version: latest
            cache: 'npm'
        - run: sudo timedatectl set-timezone 'Asia/Shanghai'   
       # - name: å®‰è£…ä¾èµ– 
       #   run: |
       #     python -m pip install --upgrade pip
       #     pip install -r requirements.txt
       # - name: èŠ‚ç‚¹åˆ†å‰² 
       #   run: python ./check/split.py
        - name: èŠ‚ç‚¹åˆæˆ
          run :
           cat ./collected-proxies/row-url/all_* >./collected-proxies/row-url/all.txt
           cat ./collected-proxies/row-url/actives_* >./collected-proxies/row-url/actives.txt
           cat ./collected-proxies/xray-json/actives_now_* >./collected-proxies/xray-json/actives_all.txt
        - name: å¯¹æ¯”ä»“åº“ # Commit Files # æäº¤
          run: |
            git config --local user.email "932624033@qq.com"
            git config --local user.name "yyyr-otz"
            git add -A ./collected-proxies/row-url/all.txt ./collected-proxies/row-url/actives.txt ./collected-proxies/xray-json/actives_all.txt
            git diff-index --quiet HEAD || (git commit -a -m " èŠ‚ç‚¹æ£€æŸ¥-åˆå¹¶å®Œæˆ ğŸ• $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M %Z')" --allow-empty)
#         # git commit -am "èŠ‚ç‚¹åˆ†å‰² $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M %Z')"
        - name: æ¨é€æ›´æ”¹ # Push Changes # æ¨é€
          uses: ad-m/github-push-action@v0.6.0
          with:
            github_token: ${{ secrets.ACTIONS_SECRETS_TOKEN }}
            branch: master
